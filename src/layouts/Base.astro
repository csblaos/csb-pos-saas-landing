---
import '../styles/global.css';
import { ViewTransitions } from 'astro:transitions';
import { getLangFromUrl } from '../lib/lang';
import ScrollToTop from '../components/islands/ScrollToTop';
import { buildDefaultSchemas, resolveSeo } from '../lib/seo';
import type { SeoPageKey } from '../data/seo/pages';
import { getThemeCssVariables } from '../config/theme';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  seoKey?: SeoPageKey;
  noindex?: boolean;
  ogType?: 'website' | 'article';
}

const lang = getLangFromUrl(Astro.url);

const {
  title,
  description,
  image,
  seoKey,
  noindex = false,
  ogType = 'website'
} = Astro.props as Props;

const seo = resolveSeo({
  lang,
  pathname: Astro.url.pathname,
  pageKey: seoKey,
  title,
  description,
  image,
  noindex,
  ogType
});

const schemaPayloads = buildDefaultSchemas(lang).map((item) => JSON.stringify(item));
const themeInlineStyle = Object.entries(getThemeCssVariables())
  .map(([name, value]) => `${name}: ${value}`)
  .join('; ');
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={seo.description} />
    <meta name="robots" content={seo.robots} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="canonical" href={seo.canonical} />
    {seo.alternates.map((alternate) => (
      <link rel="alternate" hreflang={alternate.hreflang} href={alternate.href} />
    ))}
    <link rel="alternate" hreflang="x-default" href={seo.xDefault} />
    <meta name="generator" content={Astro.generator} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={seo.ogType} />
    <meta property="og:site_name" content={seo.siteName} />
    <meta property="og:locale" content={seo.locale} />
    <meta property="og:url" content={seo.canonical} />
    <meta property="og:title" content={seo.title} />
    <meta property="og:description" content={seo.description} />
    <meta property="og:image" content={new URL(seo.image, Astro.url).toString()} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={seo.canonical} />
    <meta name="twitter:title" content={seo.title} />
    <meta name="twitter:description" content={seo.description} />
    <meta name="twitter:image" content={new URL(seo.image, Astro.url).toString()} />

    <title>{seo.title}</title>

    {schemaPayloads.map((schemaJson) => (
      <script type="application/ld+json" set:html={schemaJson}></script>
    ))}
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+Thai:wght@400;600;800&family=Noto+Sans+Lao:wght@400;600;800&display=swap" rel="stylesheet">
    
    <ViewTransitions />
    <style is:global>
      @view-transition {
        navigation: auto;
      }
      
      /* Ultra-fast page transition for snappy UX */
      ::view-transition-old(root),
      ::view-transition-new(root) {
        animation-duration: 0.15s;
        animation-timing-function: ease-out;
      }
    </style>
    <script is:inline>
      // Language Logic (Auto-Redirect)
      if (typeof localStorage !== 'undefined') {
        try {
          const storedLang = localStorage.getItem('lang');
          const pathSegments = window.location.pathname.split('/').filter(Boolean);
          const langInPath = pathSegments[0];
          
          // Only redirect if we have a stored language and we're at root or no language in path
          if (storedLang && (!langInPath || !['en', 'th', 'la'].includes(langInPath))) {
            window.location.replace(`/${storedLang}/`);
          }
        } catch {
          // Ignore storage access issues in strict privacy mode.
        }
      }

      // Restore scroll position after switching language.
      if (typeof sessionStorage !== 'undefined') {
        const raw = sessionStorage.getItem('__lang_scroll_restore__');
        if (raw) {
          sessionStorage.removeItem('__lang_scroll_restore__');
          try {
            const restoreData = JSON.parse(raw);
            const currentPathWithQuery = window.location.pathname + window.location.search;
            const age = Date.now() - Number(restoreData?.ts || 0);

            if (restoreData?.toPath === currentPathWithQuery && age >= 0 && age < 15000) {
              const restoreScroll = () => {
                const maxScrollable = Math.max(0, document.documentElement.scrollHeight - window.innerHeight);
                const ratio = Number(restoreData?.ratio || 0);
                let targetY = Number(restoreData?.y || 0);

                if (maxScrollable > 0 && ratio > 0) {
                  targetY = ratio * maxScrollable;
                }

                targetY = Math.max(0, Math.min(targetY, maxScrollable));
                window.scrollTo(0, targetY);
              };

              restoreScroll();
              requestAnimationFrame(() => requestAnimationFrame(restoreScroll));
              window.addEventListener('load', () => setTimeout(restoreScroll, 0), { once: true });
            }
          } catch {
            // Ignore malformed restore payload.
          }
        }
      }
    </script>
  </head>
  <body class="bg-[var(--color-bg)] text-[var(--color-text)] min-h-screen flex flex-col font-sans relative overflow-x-hidden" style={themeInlineStyle}>
    <!-- Background Animation -->
    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none">
      <div class="absolute inset-0 bg-grid"></div>
    </div>
    
    <slot />
    
    <ScrollToTop client:load />
  </body>
</html>
